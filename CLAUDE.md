# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**peakfq** (package name `peakfq`, repo name `peakfqr`) is a USGS R package (v8.1.0) for flood-frequency analysis following Bulletin 17C guidelines. It combines R for workflow orchestration and a Shiny web UI with Fortran for core statistical computations (EMA algorithm, probability functions). Requires R >= 4.2.0.

## Workspace Structure

This is a VS Code multi-root workspace (`hal.code-workspace`):
- `_shared/peakfqr/` — The R package (primary codebase)
- `main/`, `hybrid-17c-cld/`, `hybrid-17c-gcp/` — Deployment targets (currently empty)
- `_shared/peakfqweb/` — Web app reference materials
- `_shared/testdata/` — Shared test data

## Build & Development Commands

```r
# Install from source
remotes::install_gitlab("water/peakfqr", host = "code.usgs.gov")

# Load package locally for development (use this instead of install during dev)
pkgload::load_all(attach_testthat = FALSE)

# Regenerate documentation from roxygen comments
devtools::document()

# Build package
R CMD build . --no-manual

# Check package (mirrors CI)
devtools::check(document = FALSE, args = "--no-tests", vignettes = FALSE)

# Launch Shiny app locally
peakfq::peakfq_app()
```

## Testing

Framework: **testthat**. Tests live in `_shared/peakfqr/tests/testthat/`.

```r
# Run all tests
devtools::test()

# Run a single test file
testthat::test_file("tests/testthat/test-fortran.R")

# Run tests with JUnit output (CI style)
devtools::test(reporter = "junit")

# Code coverage
covr::package_coverage()
```

Test files: `test-fortran.R`, `test-moments.R`, `test-MOVE3.R`, `test-skewweight.R`, `test-regionalskew.R`. Test data in `inst/extdata/` and `inst/testdata/`.

## Architecture

### R Layer (`R/`)
- **`main.R`** — `peakfq()`: primary analysis entry point. Takes a .psf specification file, returns LP3 parameters, quantiles, empirical data, MGBT results, trends, plots, and logs.
- **`shinyapp.R`** — `peakfq_app()`: launches the Shiny web interface.
- **`MOVE3.R`** — Record extension using correlation with index sites.
- **`readInputs.R`** — Parsers for RDB, PSF (specifications), and WATSTORE formats.
- **`outputs.R`** — Output generation and CSV export.
- **`ffaPlot.R`** / **`peakDataPlot.R`** — Flood frequency and data visualization plots.
- **`fortranWrappers.R`** — R wrappers around compiled Fortran routines via `.Fortran()`.

### Fortran Layer (`src/`)
- **`emafit.f`** — Expected Moments Algorithm (EMA) for LP3 distribution fitting.
- **`dcdflib1.f90`** — Probability distribution functions.
- **`probfun.f`** — Additional probability functions.
- **`registerDynamicSymbol.c`** — Dynamic symbol registration for R.

### Shiny App (`inst/app/`)
- **`server.R`** (~97KB) — Main server logic; manages data upload, analysis config, and result display.
- **`ui.R`** — Multi-tab user interface.
- **`global.R`** — Shared initialization variables and reactive value structures.

### Specification Files (.psf)
The `.psf` format is the primary input format. Key fields: `Station`, `PCPT_Thresh`, `Interval`, `SkewOpt`, `GenSkew`, `SkewSE`, `LOType`, `LoThresh`, `Urb/Reg`, `WeightOpt`. See `readPSF()` documentation for full format spec.

## Key Conventions

- Documentation uses **roxygen2** (`#'` comments) with markdown enabled. Run `devtools::document()` to regenerate `man/` and `NAMESPACE`.
- All exported functions are declared in NAMESPACE (auto-generated by roxygen2). 17 public exports including `peakfq()`, `peakfq_app()`, `MOVE3()`, `readRDB()`, `readPSF()`, `emafit()`, `ffaPlot()`.
- Changes must maintain **Bulletin 17C compliance** — this is a scientifically-rigorous package following published USGS guidelines.
- Backward compatibility with legacy PeakFQ 7.4.1–7.5.1 specification files is important (though some behaviors differ, documented in README).
- Peak flow qualification codes (3, 4, 6, 7, 8, C, O) have specific handling rules — see README for details.

## CI/CD (GitLab)

Pipeline stages: build (Docker image) → check (`devtools::check`) → test (testthat + coverage) → end (deploy). Branches: `main` (production), `develop` (development). Deployment to Posit Connect via `deploy_simple.R`.
